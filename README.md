ArchiDeathLink
==============

A lightweight relay + overlay server that connects your local Archipelago
client to archipelago.gg and exposes simple HTTP endpoints for DeathLink
triggers. Includes an HTML /stats overlay generated by the Python app (no
separate stats.html). Designed to work with Streamer.bot via HTTP requests,
no Twitch API keys required.

---------------------------------------------------------------------------
Requirements
---------------------------------------------------------------------------
- Python 3.10+
- Packages: aiohttp, websockets
  Install:
    pip install aiohttp websockets
  (Optional) Using requirements.txt:
    pip install -r requirements.txt

---------------------------------------------------------------------------
Setup
---------------------------------------------------------------------------
1) Clone
   git clone https://github.com/<your-username>/ArchiDeathLink.git
   cd ArchiDeathLink

2) Config
   Copy the example and edit:
     Windows: copy config.example.json config.json
     macOS/Linux: cp config.example.json config.json

   config.example.json fields:
     deaths_per_twitch_sub   (default 3)
     deaths_per_tiktok_sub   (default 2)
     bits_per_death          (default 100)
     coins_per_death         (default 100)
     http_port               (default 5000)
     websocket_port          (room port for archipelago.gg, e.g. 24888)
     min_dispatch_seconds    (default 240)
     max_dispatch_seconds    (default 480)
     auth_key                (optional shared key; empty disables auth)

   Note: Keep your real config.json out of git (already in .gitignore).

3) Run
   python death.py
   On first run, enter the Archipelago server port when prompted. The value
   is saved into config.json for next time.

---------------------------------------------------------------------------
Endpoints (HTTP GET)
---------------------------------------------------------------------------
All examples use localhost and port 5000. Adjust to your http_port.
If auth_key is set in config.json, add header X-Auth-Key: <key> or append
&auth_key=<key> in the query string.

Overlay:
  /stats
    Full overlay page for OBS.
    Variants:
      /stats?deaths   -> stats only
      /stats?rates    -> rates only
  /DL.png
    Optional background watermark image used by the overlay (place next to death.py)
  /deathlink_trigger.txt
    Polled by the overlay to flash the last killer banner.

Death triggers (fires 1 immediately, queues the rest with delays):
  /twitch?user=<name>&qty=<count>
  /tiktok?user=<name>&qty=<count>
  /cheer?user=<name>&qty=<bits>     (bits_per_death controls conversion)
  /coins?user=<name>&qty=<coins>     (coins_per_death controls conversion)
  /custom?user=<name>&qty=<deaths>   (raw number of deaths)

Helper:
  /manual
    Small web UI to build and call the endpoints from a browser.

---------------------------------------------------------------------------
Dispatching / Queue
---------------------------------------------------------------------------
Additional deaths beyond the first are queued and dispatched after a random
delay between min_dispatch_seconds and max_dispatch_seconds (inclusive).
This reduces bursty chains.

---------------------------------------------------------------------------
OBS Browser Source
---------------------------------------------------------------------------
1) Add a Browser Source in OBS.
2) Set the URL to:
     http://127.0.0.1:5000/stats
3) Set your desired size (e.g., 1920x1080).
4) Optional: place DL.png next to death.py for a faint background watermark.

---------------------------------------------------------------------------
Streamer.bot Examples (Execute Web Request, GET)
---------------------------------------------------------------------------
Twitch Sub:
  http://127.0.0.1:5000/twitch?user=$username&qty=$months[&auth_key=KEY]

Cheer:
  http://127.0.0.1:5000/cheer?user=$username&qty=$bits[&auth_key=KEY]

TikTok Sub:
  http://127.0.0.1:5000/tiktok?user=$username&qty=$months[&auth_key=KEY]

Custom:
  http://127.0.0.1:5000/custom?user=$username&qty=3[&auth_key=KEY]

---------------------------------------------------------------------------
Security
---------------------------------------------------------------------------
- HTTP binds to 127.0.0.1 by default (local only). If you need LAN/remote
  access, change to 0.0.0.0 in start_http_server() within death.py.
- Set auth_key in config.json to prevent unauthorized triggers. Use either
  the X-Auth-Key header or ?auth_key=... in the query.
- The relay prefers a verified TLS context. If your environment requires
  it, the code will fall back to an unverified context. Use at your own risk.

---------------------------------------------------------------------------
Files
---------------------------------------------------------------------------
Tracked:
  death.py
  config.example.json
  README.txt (this file)
  requirements.txt (optional if you add one)
  DL.png (optional overlay watermark)

Runtime (ignored by git):
  deathlink_queue.txt
  deathlink_trigger.txt
  stats.txt
  *.log
  logs/

---------------------------------------------------------------------------
Troubleshooting
---------------------------------------------------------------------------
Overlay not updating or banner missing:
  Ensure deathlink_trigger.txt is writable and in the same folder.

No deaths firing:
  Confirm your local Archipelago client is connected; watch the console for
  "DeathLink sent!" messages.

401 Unauthorized:
  Set auth_key in config.json and include it via header or query string, or
  remove/empty auth_key to disable auth.

Port already in use:
  Change http_port in config.json.

---------------------------------------------------------------------------
License
---------------------------------------------------------------------------
MIT. See LICENSE for details.
