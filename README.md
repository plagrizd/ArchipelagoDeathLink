# ArchiDeathLink

A lightweight relay + overlay server that connects your local Archipelago client to **archipelago.gg** and exposes simple HTTP endpoints for **DeathLink** triggers. Includes an HTML **/stats** overlay generated by the Python app (no separate `stats.html`). Designed to work with Streamer.bot calling HTTP endpoints — **no Twitch API keys required**.

---

## Features
- WebSocket relay between local client and archipelago.gg
- Simple HTTP endpoints to trigger DeathLinks (subs, bits/coins, custom)
- Built‑in `/stats` overlay page (HTML served by Python)
- Queued dispatch with randomized delays (anti‑burst)
- Optional shared‑key auth (`auth_key`) via header or query string
- Optional watermark (`DL.png`) background

---

## Requirements
- **Python 3.10+**
- **Install dependencies:**
  ```bash
  pip install -r requirements.txt
  # or, directly:
  pip install aiohttp websockets
  ```

---

## Setup

### 1) Clone
```bash
git clone https://github.com/<your-username>/ArchiDeathLink.git
cd ArchiDeathLink
```

### 2) Config
Copy and edit:
```bash
# Windows
copy config.example.json config.json
# macOS/Linux
cp config.example.json config.json
```
Key fields in `config.example.json`:
- `deaths_per_twitch_sub` (default **3**)
- `deaths_per_tiktok_sub` (default **2**)
- `bits_per_death` (default **100**)
- `coins_per_death` (default **100**)
- `http_port` (default **5000**)
- `websocket_port` (your archipelago.gg room port, e.g. **24888**)
- `min_dispatch_seconds` / `max_dispatch_seconds` (default **240–480**)
- `auth_key` (optional shared key; empty disables auth)

> Keep your real `config.json` out of git — it's already ignored by `.gitignore`.

### 3) Run
```bash
python death.py
```
On first run you’ll be prompted for the Archipelago server port; it’s saved back to `config.json`.

---

## Endpoints (HTTP GET)

If `auth_key` is set in `config.json`, supply it via header `X-Auth-Key: <key>` **or** append `&auth_key=<key>`.

### Overlay
- `GET /stats` — full overlay page for OBS  
  Variants: `/stats?deaths` (stats only), `/stats?rates` (rates only)
- `GET /DL.png` — optional background watermark
- `GET /deathlink_trigger.txt` — polled by overlay to flash the banner

### Triggers (fires 1 immediately, queues the rest)
- `GET /twitch?user=<name>&qty=<count>`
- `GET /tiktok?user=<name>&qty=<count>`
- `GET /cheer?user=<name>&qty=<bits>` — controlled by `bits_per_death`
- `GET /coins?user=<name>&qty=<coins>` — controlled by `coins_per_death`
- `GET /custom?user=<name>&qty=<deaths>` — raw number of deaths

### Helper
- `GET /manual` — tiny UI to build/call the endpoints from a browser

---

## OBS Browser Source
1. Add a **Browser Source** in OBS.
2. URL: `http://127.0.0.1:5000/stats`
3. Size as desired (e.g., 1920×1080). Optional: place `DL.png` next to `death.py` for a faint watermark.

---

## Streamer.bot (Execute Web Request, GET)
- Twitch Sub  
  `http://127.0.0.1:5000/twitch?user=$username&qty=$months[&auth_key=KEY]`
- Cheer  
  `http://127.0.0.1:5000/cheer?user=$username&qty=$bits[&auth_key=KEY]`
- TikTok Sub  
  `http://127.0.0.1:5000/tiktok?user=$username&qty=$months[&auth_key=KEY]`
- Custom  
  `http://127.0.0.1:5000/custom?user=$username&qty=3[&auth_key=KEY]`

---

## Security
- HTTP binds to `127.0.0.1` by default (local only). Change to `0.0.0.0` in `start_http_server()` if you need LAN/remote.
- Set `auth_key` if endpoints are reachable beyond localhost.
- The relay prefers a verified TLS context; falls back only if necessary.

---

## Files
Tracked:
- `death.py`
- `config.example.json`
- `README.md` (this file)
- `requirements.txt`
- `DL.png` (optional overlay watermark)

Runtime (gitignored):
- `deathlink_queue.txt`, `deathlink_trigger.txt`, `stats.txt`, `logs/`, `*.log`

---

## Troubleshooting
- **Overlay not updating / banner missing** — ensure `deathlink_trigger.txt` is writable and next to `death.py`.
- **No deaths firing** — confirm the local Archipelago client is connected; look for “DeathLink sent!” in console.
- **401 Unauthorized** — include the auth key via header or query string, or disable by emptying `auth_key`.
- **Port in use** — change `http_port` in `config.json`.

---

## Maintainer
- **Plagrizr Gaming**
  - Email: [plagrizr@gmail.com](mailto:plagrizr@gmail.com)
  - Website: https://plagrizr.com
  - Twitch: https://twitch.tv/plagrizr
  - YouTube: https://www.youtube.com/@plagrizr-gaming

---

## License
MIT. See `LICENSE`.
